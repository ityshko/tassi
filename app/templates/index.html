<html>

    <head>

    </head>

    <body onload="OnPageRender()">

        <style>
            .new_segment{background-color: #66cdaa;}
            .old_segment{background-color: white;}
            .whitelist{background-color: #dddddd;}
            .key{font-size: 12px;}
            .header{padding:10px; font-weight:bold;}
            .cell{padding:10px; vertical-align:top; word-wrap:break-word;}
        </style>

        <table width="100%" border="1" style="table-layout: fixed; border-collapse:collapse;">
            <tr>
                <td width="20%" class="header">Key</td>
                <td width="35%" class="header">Original</td>
                <td width="35%" class="header">Translation</td>
            </tr>
            {% for segment in segments %}
            <tr segment="true" {% if segment.in_whitelist %}whitelist="True" {% endif %}>
                <td width="20%" class="key">{{segment.key}}</td>
                <td width="35%" class="cell" onclick="OnCellClick(this, false)" lang="ru">{{segment.original}}</td>
                <td width="35%" class="cell" onclick="OnCellClick(this, true)" lang="ua">{{segment.translation}}</td>
            </tr>
            {% endfor %}

        </table>

        <script>
            var activeCell = null;

            var tds = document.getElementsByTagName('td');
            for (var i = 0; i < tds.length; i++) {
                tds[i].innerHTML = tds[i].innerHTML.replace(/\n\n/g, '<br>')
            }

            function InitTextarea(ta) {
                ta.setAttribute('style', 'height:' + (ta.scrollHeight) + 'px;overflow-y:hidden;');
                ta.addEventListener("input", OnInput, false);
            }

            function OnPageRender() {
                var rows = document.getElementsByTagName('tr');
                for (var i = 1; i < rows.length; i++) {
                    if (rows[i].hasAttribute("segment")) {
                        OnRowRender(rows[i]);
                    }
                }
            }

            function OnRowRender(row) {
                var cells = row.getElementsByTagName("td");
                var source = cells[1].innerHTML;
                var transl = cells[2].innerHTML;
                <!--cell is New-->
                if (row.hasAttribute("whitelist")) {
                    row.className = "whitelist";
                }
                else if (source == transl) {
                    row.className = "new_segment";
                }
                <!--cell is Translated-->
                else {
                    row.className = "old_segment";
                }
            }

            function OnInput() {
              this.style.height = 'auto';
              this.style.height = (this.scrollHeight) + 'px';
            }

            function OnCellClick(cell, is_translation) {

                if (activeCell == cell) {
                    return;
                }
                else if (activeCell != null) {
                    ResetCell(activeCell, is_translation);
                }
                var content = cell.innerHTML;
                while (cell.firstChild)
                    cell.removeChild(cell.firstChild);

                var ta = document.createElement('textarea');
                <!--var p = e.parentNode;-->
                <!--cell.style.display = "none";-->

                ta.value = content.replace(/<br>/g, '\n');
                ta.cols = 60;

                cell.appendChild(ta);
                InitTextarea(ta);

                ta.focus();

                activeCell = cell;
            }

            function ResetCell(cell, is_translation) {
                var ta = cell.getElementsByTagName("textarea")[0];

                var lang = cell.getAttribute("lang");
                var k = cell.parentElement.getElementsByTagName("td")[0].innerText;
                var t = ta.value;

                cell.removeChild(ta);

                ReportChange(lang, k, t.replace(/\n/g, '\n\n'));
                cell.innerHTML = t.replace(/\n/g, '<br>');

                OnRowRender(cell.parentNode);
            }

            function ReportChange(lang, k, v) {
                var request = new XMLHttpRequest();
                request.onload = function() {
                    console.log("Request for " + k + ":" + v + "");
                    console.log("Status: " + request.status);
                    console.log("Response:" + request.responseText);
                }
                request.onreadystatechange = function() {
                    if (request.readyState == XMLHttpRequest.DONE) {
                        if (request.status != 200) {
                            alert(request.statusText);
                        }
                    }
                }
                request.open("POST", "http://127.0.0.1:5000/report", true);
                request.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
                var body = JSON.stringify({ "lang": lang, "key": k, "translation": v })
                request.send(body)
            }

            function onKeyUpListener(e) {
                var keyCode = e.which;
                if ((keyCode == 27) && activeCell) {
                    ResetCell(activeCell);
                    activeCell = null;
                }
            }

        </script>

        <script>
            window.addEventListener("keyup", onKeyUpListener, false);
        </script>


    </body>

</html>
